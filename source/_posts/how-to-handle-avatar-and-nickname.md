---
title: 如何更好的处理查询用户的头像和昵称
date: 2017-07-12 20:25:34
categories: "idea"
tags:
    - mysql -
---
在日常的业务处理中,我们需要各种复杂的逻辑,但其实核心永远都是围绕这用户而开始的.用户信息复杂多样,可是其中我们最常用的就限于其中几个,比如用户名,id还是头像.  
用户的id是唯一不变了,用户昵称和头像是可变的.在有些业务下,用户id是作为一个键值存入相应的数据表中的,而用户昵称和头像并不会一定存入对应表中.我们需要在用的时候才去查询.  
这样在某些情况下,其实造成了很大的效率浪费.比如一个业务的信息是存在mongodb中的,但是需要用户的昵称,而用户是在mysql中的,这样在查询的时候,有很大的一部分的时间是用在查询mysql上面,非常得不偿失.所以如何更好的处理用户头像和昵称是很重要的.  
下面说几种我认为这种情况下处理比较好的方法.  
<!--more-->
1.在查询用户信息并不占用很大时间
 这时候直接进入mysql查询也未尝不可,比如在查看文章详情的时候,获取用户信息其实并没有对整个业务产生多大影响,甚至你可以在页面上异步获取昵称头像信息,因为用户关注的重点在于文章的详情.

2.在一个业务中大量查询用户信息  
 比如获取一个文章列表,里面就需要不停的查询数据库,这样其实大部分时间并没有放在业务逻辑,而是用在取用户的头像昵称了.这种大量查询用户信息的情况下,我建议将用户的信息放在缓存中,比如redis中.  
     而将用户基本信息全部存在缓存中的好处就是大量减少查询时间和数据库压力.但是同时又存在缓存信息的及时性.比如用户的信息是随时可以变的.  
     这里又有2种处理方法.  
     一是在用户修改信息的时候同时更新缓存信息  二是定时根据用户信息的修改时间更新缓存.  
     这里我推荐使用第一种及时更新的方法,因为单个用户修改信息并刷缓存几乎不浪费时间,而第二种就很难定期时间的长短和信息的及时性.

3.在昵称和头像不随时获取时
 在很多像帖子这种doc类型数据上,我们经常采用是将用户的头像和昵称也一起存入数据中的.这样我们可以不用去访问mysql或者缓存,效率非常的高.这时候如何保证头像和昵称的正确就很重要了  ,我们就必须有个定时同步头像和昵称的策略.   
- 如果我们所有的帖子都要更新,在数据量非常多的情况下是很慢的.这时候我们可以设定一个更新的日期,比如非常久远的帖子,几乎没有任何的访问量,即使作者自己也许都不会在看了,这时候我们采用不去同步,或者按非常低的优先级去同步,完全不会影响正常的体验.
- 比如新浪微博中,非常热门微博的评论有时候会达到几十万,而评论里面的二级回复有时候也会达到上万,这时候访问量会特别大.而这时候修改个人信息后,就必须立刻显示出来,不然体验就非常差了.像这种情况下,我们可以特殊处理,就是不采用已经存入数据的头像昵称,而是去获取上面2中所讲的缓存中的头像昵称.
- 从用户的使用角度上,我们可以发现,在正常情况下,用户对于昵称和头像的修改频率是随着使用时间的长度而慢慢减少的,所以我们在同步时可以对注册时间越长(活跃度越少)的用户的同步进行降低优先级.
 
4.头像的处理.  
一般图片都是异步加载的,也就是图片的加载速度并不会影响数据的获取效率,但是头像加载太慢也会影响体验度.这时候前端也是需要做缓存的.  
这里说一种用唯一id的思维考虑怎么修改头像.通常我们存入数据库的是图片的名字比如1.jpg,然后取出的时候拼接上图片服务器的前缀.正常我们上传头像是不会去图片本有的名字,而是采取我们生成的名字,比如时间加上一段随机串.这里我们可以知道每次我们修改都会生成一个新的名字然后再存入数据库.  
这里我们可以这样做,就是头像在第一次生成名称后就不需要在改变了就如用户id一样.我门需要处理的是在修改头像的时候(不管是采取三方还是自己的图片服务器),将原来的图片做一个移动或重命名操作(保证这个图片的归属性可以确定即可),这样我们在用原来的名字命名需要上传的图片,这样图片的名称依旧没有改变,但其实图片是换掉了.这样操作我们就省了一步修改数据库的操作.

总结.这里只是提供了自己的几种处理的想法,并没有提供具体的实现方案.可能并不很完善,仅供参考.