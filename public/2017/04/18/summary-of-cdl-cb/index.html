<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="java," />








  <link rel="shortcut icon" type="image/x-icon" href="/images/rain.ico?v=5.1.0" />






<meta name="description" content="学concurrent并发包的时候,看到countDownLatch和CyclicBarrier有些相似的地方.所以放在一起进行学习分析一下.  首先看一下jdk注释的第一句话简单阐明二者各自的意思:
12345CountDowLatchA synchronization aid that allows one or more threads to wait until a set of o">
<meta property="og:type" content="article">
<meta property="og:title" content="CountDownLatch和CyclicBarrier原理的分析理解">
<meta property="og:url" content="http://www.iwouldbe.com/2017/04/18/summary-of-cdl-cb/index.html">
<meta property="og:site_name" content="xiaoyu">
<meta property="og:description" content="学concurrent并发包的时候,看到countDownLatch和CyclicBarrier有些相似的地方.所以放在一起进行学习分析一下.  首先看一下jdk注释的第一句话简单阐明二者各自的意思:
12345CountDowLatchA synchronization aid that allows one or more threads to wait until a set of o">
<meta property="og:updated_time" content="2017-04-18T07:47:46.108Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CountDownLatch和CyclicBarrier原理的分析理解">
<meta name="twitter:description" content="学concurrent并发包的时候,看到countDownLatch和CyclicBarrier有些相似的地方.所以放在一起进行学习分析一下.  首先看一下jdk注释的第一句话简单阐明二者各自的意思:
12345CountDowLatchA synchronization aid that allows one or more threads to wait until a set of o">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 'undefined',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.iwouldbe.com/2017/04/18/summary-of-cdl-cb/"/>





  <title> CountDownLatch和CyclicBarrier原理的分析理解 | xiaoyu </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?208824764387c8efd4b200bc878c1dec";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">xiaoyu</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.iwouldbe.com/2017/04/18/summary-of-cdl-cb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xiaoyu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/head.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaoyu">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                CountDownLatch和CyclicBarrier原理的分析理解
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-18T15:44:25+08:00">
                2017-04-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a class="cloud-tie-join-count" href="/2017/04/18/summary-of-cdl-cb/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count join-count" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>   学concurrent并发包的时候,看到countDownLatch和CyclicBarrier有些相似的地方.所以放在一起进行学习分析一下.<br>  首先看一下jdk注释的第一句话简单阐明二者各自的意思:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">CountDowLatch</div><div class="line">A synchronization aid that allows one or more threads to wait until a set of operations being performed in other threads completes</div><div class="line"></div><div class="line">CyclicBarrier</div><div class="line">A synchronization aid that allows a set of threads to all wait for each other to reach a common barrier point</div></pre></td></tr></table></figure>
 <a id="more"></a>
<p>  简单的意思就是CountDownLatch(下文用CDL)用于同步时一个或多个线程等待其他线程的某些操作完后才继续进行,而CyclicBarrier(下文用CB)用于若干线程需要阻塞在一个地方,够数了然后在同时进行.<br> <strong>先分析CDL</strong>.<br>   用法上CDL初始化必须带有一个count,表示需要countDown方法需要调用几次后才能接着进行.<br>   主要的api有:<br> countDown(). 用来其他线程调用,没调用一次count–,直到为0后,CDL作用消失,线程继续进行</p>
<p> await().用于线程设置在哪个地方设置阻塞等待,类似对象的wait()函数.</p>
<p>   所以基本的用法伪代码如下:<br> CDL latch = new CDL(2);<br> thread A {<br>      ……<br>      latch.await();<br>      …….<br> }<br> thread B {<br>     ……<br>     latch.countDown();<br>     ……<br> }<br> thread C {<br>     ……<br>     latch.countDown();<br>     ……<br> }<br>  这样在thread B ,C都调用过countDown()后,A才能继续进行.<br>然后,我们通过看一下源码来理解一下其中的过程.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public CountDownLatch(int count) &#123;</div><div class="line">    if (count &lt; 0) throw new IllegalArgumentException(&quot;count &lt; 0&quot;);</div><div class="line">    this.sync = new Sync(count);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  构造方异法里面我们看到其实是实现了内部类Sync,这个类其实是继承了AbstractQueuedSynchronizer即AQS,这是并发包里面很多类实现的基础.这里留着改天深入研究一下.我们先看看这个Sync的实现.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">Sync(int count) &#123;</div><div class="line">           setState(count);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       int getCount() &#123;</div><div class="line">           return getState();</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       protected int tryAcquireShared(int acquires) &#123;</div><div class="line">           return (getState() == 0) ? 1 : -1;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       protected boolean tryReleaseShared(int releases) &#123;</div><div class="line">           // Decrement count; signal when transition to zero</div><div class="line">           for (;;) &#123;</div><div class="line">               int c = getState();</div><div class="line">               if (c == 0)</div><div class="line">                   return false;</div><div class="line">               int nextc = c-1;</div><div class="line">               if (compareAndSetState(c, nextc))</div><div class="line">                   return nextc == 0;</div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<p>  我们通过Sync的方法来看await()源码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public void await() throws InterruptedException &#123;</div><div class="line">       sync.acquireSharedInterruptibly(1);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里sync调用的方法其实是父类AQS里面的方法,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public final void acquireSharedInterruptibly(int arg)</div><div class="line">         throws InterruptedException &#123;</div><div class="line">     if (Thread.interrupted())</div><div class="line">         throw new InterruptedException();</div><div class="line">     if (tryAcquireShared(arg) &lt; 0)</div><div class="line">         doAcquireSharedInterruptibly(arg);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>  我们看到其实这里还是通过调用tryAcquireShared方法实现的,而在AQS里面tryAcquireShared方法还是需要子类实现的,也就是最后调用的就是Sync里面的tryAcquireShared,我们回到Sync源码里面.<br>这个Sync在构造函数里面设置线程state就是count,<br>  再看tryAcquireShared方法,里面的形参acquires其实根本没用到,只是判断了state即count数等于0,也就是这里线程state其实没有原来的意思了,只是用于count计数而已.<br>  通过上面acquireSharedInterruptibly方法我们可以看出,只要<br>tryAcquireShared大于0(即count还不是0)的话CDL的await()方法就没有阻塞,真正的阻塞实现是在doAcquireSharedInterruptibly(1)里面.这两个要具体分析就要扯到AQS的实现了,我们这里只要知道这里就是CDL产生阻塞的原因就行了.<br>分析完await()方法后,我们来看一下countDown():</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public void countDown() &#123;</div><div class="line">        sync.releaseShared(1);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这里调用的依旧是sync父类里面的方法.在父类AQS里面的实现如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public final boolean releaseShared(int arg) &#123;</div><div class="line">       if (tryReleaseShared(arg)) &#123;</div><div class="line">           doReleaseShared();</div><div class="line">           return true;</div><div class="line">       &#125;</div><div class="line">       return false;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>  我们看到其实核心还是调用sync里面tryReleaseShared,<br>回到sync里面的实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">protected boolean tryReleaseShared(int releases) &#123;</div><div class="line">           // Decrement count; signal when transition to zero</div><div class="line">           for (;;) &#123;</div><div class="line">               int c = getState(); (1)</div><div class="line">               if (c == 0) (2)</div><div class="line">                   return false; (3)</div><div class="line">               int nextc = c-1; (4)</div><div class="line">               if (compareAndSetState(c, nextc)) (5)</div><div class="line">                   return nextc == 0; (6)</div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<p>  这里没有使用锁来实现,而是通过CAS(即比较交换)算法来实现,CAS的具体实现是调用更底层的UnSafe类,我们只要知道这是一种不通过锁来实现同步的方法,所以相对比较高效.<br>1,2,3处表示先检查 count是否为0,也就是说到CDL不在阻塞的时候在调用countDown方法不会在起作用了,这也意味着CDL是不能重用的.<br>5,6处通过CAS方法使得count减1,当然这里其实不是真的count减了1,而是state,只是这里state就是代表了count的意思而已.<br>到这里为止,CDL的主要方法和原理都分析完了,我们看到其内部实现完全依靠Sync,也就是AQS,但这里Sync的实现也非常简练易懂.<br><strong>接下来我们来分析CB</strong><br>  虽然CB和CDL意思有些相似,但是实现上确不一样.<br>CB同样实现了一个内部类Generation,意为一代,但是主要功能还是通过reentranLock实现的.<br>先来看看CB源码里面定义的几个遍量:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">private final ReentrantLock lock = new ReentrantLock();</div><div class="line">private final Condition trip = lock.newCondition();</div><div class="line">private final int parties;</div><div class="line">private final Runnable barrierCommand;</div><div class="line">private Generation generation = new Generation();</div><div class="line">private int count;</div></pre></td></tr></table></figure>
<p>lock用来加锁<br>trip这里英文不是旅游的意思,而是绊倒的意思,也许正好和Barrier(栅栏)相对应吧,栅栏几个栏杆挡着不给你走,来一个线程绊倒一个栏杆,倒完了路就通了.<br>parties 英文意党羽,代表这里需要挡住的线程数量,这个值在初始化后就不会变了,<br>barrierCommand:栅栏通了后就会执行这个命令.<br>generation意为一代,代表此刻这个栅栏<br>count 线程的数量,初始化时和parties相等</p>
<p>再看CB的两个构造函数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public CyclicBarrier(int parties) &#123;</div><div class="line">       this(parties, null);</div><div class="line">   &#125;</div><div class="line">   public CyclicBarrier(int parties, Runnable barrierAction) &#123;</div><div class="line">       if (parties &lt;= 0) throw new IllegalArgumentException();</div><div class="line">       this.parties = parties;</div><div class="line">       this.count = parties;</div><div class="line">       this.barrierCommand = barrierAction;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>  我们主要看第二个构造函数,初始化时parties赋值给了count,我们上面说的parties不会变的原因是程序最后修改的都是count.</p>
<p>再来看CB的主要几个方法:<br>getPaties()获取要拦的线程的数量,返回的parties,也就是初始化的数量.</p>
<p>isBroken()判断栅栏是否坏了,是通过lock锁实现的,返回的是Generation类里面唯一的变量broken,同时我们看看Generation类的定义,非常简单:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">private static class Generation &#123;</div><div class="line">      boolean broken = false;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>这个内部类就持有一个bool变量,代表这个栅栏有没有坏掉(因为某些异常).</p>
<p>reset() 重置栅栏,意思就是一切重新开始了,之前拦截的都不算数了.这也和CB的名字Cyclic(循环)相符,也是CB的最大特点,她是可以一直重复使用的.reset方法同样用了lock锁,核心调用了两个私有方法,breakBarrier()和nextGeneration() (破坏栅栏和生成新的栅栏)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">public void reset() &#123;</div><div class="line">    final ReentrantLock lock = this.lock;</div><div class="line">    lock.lock();</div><div class="line">    try &#123;</div><div class="line">        breakBarrier();   // break the current generation</div><div class="line">        nextGeneration(); // start a new generation</div><div class="line">    &#125; finally &#123;</div><div class="line">        lock.unlock();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们来看看这俩个私有方法的实现:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">private void breakBarrier() &#123;</div><div class="line">     generation.broken = true;</div><div class="line">     count = parties;</div><div class="line">     trip.signalAll();</div><div class="line"> &#125;</div><div class="line">private void nextGeneration() &#123;</div><div class="line">     trip.signalAll();</div><div class="line">     count = parties;</div><div class="line">     generation = new Generation();</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>  breakBarrier首先设置generation为坏掉的状态,然后重置count为初始化数量,最后通过trip这个Condition来通知所有的线程这个栅栏坏了.<br>  nextGeneration用在代表目前的栅栏坏掉或者目的达成了后,重新开始设置新的栅栏,先通过trip所有线程栅栏已经可以通过了,然后重置count,生成新的栅栏.<br>  最后我们看看核心的方法也就是用来拦住线程的await方法,这个方法有俩种 ,一个带有时间限制,一个不带,但是都只是调用了私有方法dowait,所以我们只要看dowait方法就行了.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line">private int dowait(boolean timed, long nanos)</div><div class="line">       throws InterruptedException, BrokenBarrierException,</div><div class="line">              TimeoutException &#123;</div><div class="line">       final ReentrantLock lock = this.lock;</div><div class="line">       lock.lock();</div><div class="line">       try &#123;</div><div class="line">           final Generation g = generation;</div><div class="line"></div><div class="line">           if (g.broken) (1)</div><div class="line">               throw new BrokenBarrierException();</div><div class="line"></div><div class="line">           if (Thread.interrupted()) &#123; (2)</div><div class="line">               breakBarrier();</div><div class="line">               throw new InterruptedException();</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           int index = --count;(3)</div><div class="line">           if (index == 0) &#123;  // tripped</div><div class="line">               boolean ranAction = false;</div><div class="line">               try &#123;</div><div class="line">                   final Runnable command = barrierCommand;</div><div class="line">                   if (command != null)</div><div class="line">                       command.run();</div><div class="line">                   ranAction = true;</div><div class="line">                   nextGeneration();(4)</div><div class="line">                   return 0;</div><div class="line">               &#125; finally &#123;</div><div class="line">                   if (!ranAction) (5)</div><div class="line">                       breakBarrier();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           // loop until tripped, broken, interrupted, or timed out</div><div class="line">           for (;;) &#123;(6)</div><div class="line">               try &#123;</div><div class="line">                   if (!timed)</div><div class="line">                       trip.await();</div><div class="line">                   else if (nanos &gt; 0L)</div><div class="line">                       nanos = trip.awaitNanos(nanos);</div><div class="line">               &#125; catch (InterruptedException ie) &#123;</div><div class="line">                   if (g == generation &amp;&amp; ! g.broken) &#123;(7)</div><div class="line">                       breakBarrier();</div><div class="line">                       throw ie;</div><div class="line">                   &#125; else &#123;</div><div class="line">                       // We&apos;re about to finish waiting even if we had not</div><div class="line">                       // been interrupted, so this interrupt is deemed to</div><div class="line">                       // &quot;belong&quot; to subsequent execution.</div><div class="line">                       Thread.currentThread().interrupt();(8)</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               if (g.broken)</div><div class="line">                   throw new BrokenBarrierException();</div><div class="line"></div><div class="line">               if (g != generation)</div><div class="line">                   return index;</div><div class="line"></div><div class="line">               if (timed &amp;&amp; nanos &lt;= 0L) &#123;</div><div class="line">                   breakBarrier();</div><div class="line">                   throw new TimeoutException();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125; finally &#123;</div><div class="line">           lock.unlock();</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>  核心依然是用来lock锁来阻塞线程.<br>  我们先来看看这句代码 final Generation g = generation;讲这个意思是jdk很多地方都在方法内部通过final局部变量的方式引用全局变量,这样做的好处就是一是提高效率,二是对垃圾回收也有好处(不过这里的确需要一个g的局部变量,后面会讲到),这样的方式我看到了很多次,也算一种编程技巧吧.<br>  接下来的(1) (2)两处意思是如果栅栏坏了或者当前线程中断了都会导致栅栏失效,一切重来.(3)处的意思是每一个线程调用到await()时,count都会减少1,当减到0时(栅栏任务完成),接下来判断了是否有command命令需要执行.这些都完成后执行(4)处nextGeneration()重新生成栅栏.<br>  (5)处代表了在command运行的时候发生了某些异常,导致没有正常生成nextGeneration,那么就破坏栅栏,重新来过.<br>  最后我们看(6)处,这里通过一个for死循环来进行线程的阻塞判断操作,先是判断有没有设置时间限制,在线程阻塞时遇到InterruptedException(中断异常),捕获异常后里面有个if/else,<br>这里分为两种情况,一种是当前线程在await的时候出现了中断,一种是别的线程出现了中断操作.<br>1.当是别的线程中断时,在这个时候栅栏还没有生成新的generation且没坏,那么就需要当前线程破坏栅栏了.<br>2.当是自己的中断,异常捕获后,中断标记会被清除,所以需要再次主动中断恢复中断标记,这里jdk里面还专门做了解释,并说是属于后来的执行动作,也就是说是为了通知其他线程捕获异常来破坏栅栏.</p>
<p>最后依然是对栅栏进行一些异常情况的判断.</p>
<p>  至此CDL和CB都分析完了,也是自己的一些简单的理解,如若不对,请看到的人能耐心指教一下.下面贴出我写的一个中国式过马路的例子来将二者结合起来的用法供大家参考.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line">class Person implements Runnable &#123;</div><div class="line"></div><div class="line">	private TrafficLight light;</div><div class="line">	private String name;</div><div class="line"></div><div class="line">	public Person(TrafficLight light) &#123;</div><div class="line">		this.light = light;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public void setName(String name) &#123;</div><div class="line">		this.name = name;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public void run() &#123;</div><div class="line">		System.out.println(name + &quot;等红灯中.....&quot;);</div><div class="line">		light.peopleWaitRedLight();</div><div class="line">		System.out.println(name + &quot;过马路....哒哒哒...&quot;);</div><div class="line"></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">class Driver implements Runnable &#123;</div><div class="line">	private TrafficLight light;</div><div class="line"></div><div class="line">	public Driver(TrafficLight light) &#123;</div><div class="line">		this.light = light;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public void run() &#123;</div><div class="line">		System.out.println(&quot;司机等红灯中...烦烦烦...&quot;);</div><div class="line">		light.driverWaitRedLight();</div><div class="line">		System.out.println(&quot;司机过马路喽...嘟嘟嘟...&quot;);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">class TrafficLight &#123;</div><div class="line">	private CyclicBarrier barrier;</div><div class="line">	private CountDownLatch latch;</div><div class="line"></div><div class="line">	public TrafficLight(CyclicBarrier barrier, CountDownLatch latch) &#123;</div><div class="line">		this.barrier = barrier;</div><div class="line">		this.latch = latch;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public void driverWaitRedLight() &#123;</div><div class="line">		try &#123;</div><div class="line"></div><div class="line">			latch.await();</div><div class="line">			Thread.sleep(1);// 让人完全走过去</div><div class="line">		&#125; catch (InterruptedException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public void peopleWaitRedLight() &#123;</div><div class="line">		try &#123;</div><div class="line">			this.barrier.await();</div><div class="line">			System.out.println(&quot;凑够数了,大家一起闯红灯了.&quot;);</div><div class="line">		&#125; catch (InterruptedException | BrokenBarrierException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125; finally &#123;</div><div class="line">			if (latch != null) &#123;</div><div class="line">				latch.countDown();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">main函数</div><div class="line">	public static void main(String args[]) throws Exception &#123;</div><div class="line">		List&lt;Person&gt; list = new ArrayList&lt;&gt;();</div><div class="line">		CyclicBarrier barrier = new CyclicBarrier(5);</div><div class="line">		CountDownLatch latch = new CountDownLatch(10);</div><div class="line">		TrafficLight light = new TrafficLight(barrier, latch);</div><div class="line">		for (int i = 1; i &lt;= 10; i++) &#123;</div><div class="line">			list.add(new Person(light));</div><div class="line">		&#125;</div><div class="line">		Driver driver = new Driver(light);</div><div class="line">		new Thread(driver).start();</div><div class="line">		Thread t = null;</div><div class="line">		for (Person p : list) &#123;</div><div class="line">			p.setName(&quot;p&quot; + (list.indexOf(p) + 1));</div><div class="line">			t = new Thread(p);</div><div class="line">			t.start();</div><div class="line">			Thread.sleep(500);// 每过500ms来一个人</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125;</div></pre></td></tr></table></figure>
      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/java/" rel="tag"># java</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/03/20/inject-static-variable-in-spring/" rel="next" title="spring注入static变量">
                <i class="fa fa-chevron-left"></i> spring注入static变量
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/04/18/save-emoji-in-mysql/" rel="prev" title="怎么将emoji表情存入mysql">
                怎么将emoji表情存入mysql <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/head.jpg"
               alt="xiaoyu" />
          <p class="site-author-name" itemprop="name">xiaoyu</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/dressrosa" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">xiaoyu</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  
    
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "bf7fd93923494947a1e09d9ea09940a6",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
  







  
  

  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  


  

</body>
</html>
